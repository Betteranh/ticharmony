<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main}">
<head>
    <title>Liste des Partenaires</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
          rel="stylesheet">
</head>
<div layout:fragment="content" class="max-w-7xl mx-auto w-full min-h-screen pt-20 pb-12">

    <div th:if="${param.registrationSuccess}"
         class="mb-4 rounded bg-green-100 border border-green-300 text-green-800 px-4 py-2 text-center shadow">
        Le partenaire a bien été inscrit !
    </div>

    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-y-2">
        <h2 class="text-3xl font-bold text-gray-800 mb-4 md:mb-0">
            Partenaires
            <span class="text-sm font-medium text-gray-500" th:text="'(' + ${partners.size()} + ')'">()</span>
        </h2>
        <div class="flex flex-col items-end w-full md:w-auto">
            <div class="relative w-full max-w-xs">
                <input type="text" id="partnerSearch" placeholder="Rechercher un partenaire..."
                       class="pl-10 pr-4 py-2 w-full border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                       onkeyup="filterPartners(this.value)">
                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2"
                     fill="currentColor"
                     viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                          d="M12.9 14.32a8 8 0 111.414-1.414l4.387 4.387a1 1 0 01-1.414 1.414l-4.387-4.387zM14 8a6 6 0 11-12 0 6 6 0 0112 0z"
                          clip-rule="evenodd"/>
                </svg>
            </div>
            <a sec:authorize="hasRole('ADMIN')" th:href="@{/registration}"
               class="mt-3 inline-flex items-center px-5 py-2 border border-transparent text-sm font-medium rounded-lg shadow text-white bg-blue-600 hover:bg-blue-700 transition whitespace-nowrap">
                + Ajouter un partenaire
            </a>
        </div>
    </div>

    <div class="overflow-x-auto bg-white rounded-lg shadow">
        <table id="partnersTable" class="min-w-full divide-y divide-gray-200">
            <thead class="bg-indigo-600 sticky top-0">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-semibold text-white uppercase">Entreprise</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-white uppercase">Contact</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-white uppercase">Langue</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-white uppercase">Email</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-white uppercase">Tél.</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-white uppercase">Adresse</th>
                <th class="px-6 py-3 text-center text-xs font-semibold text-white uppercase">Action</th>
            </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
            <tr th:each="partner : ${partners}"
                class="even:bg-gray-50 hover:bg-gray-100 transition-colors">
                <td class="px-6 py-4 whitespace-nowrap text-gray-800"
                    th:text="${partner.nomEntreprise ?: partner.login}">Nom entreprise
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-gray-800"
                    th:text="${partner.firstname + ' ' + partner.lastname}">Prénom Nom
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span th:text="${partner.langue.toUpperCase()}"
                          class="inline-block px-2 py-0.5 text-xs font-semibold rounded bg-gray-100 text-gray-800">
                      FR
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-gray-800" th:text="${partner.email}">
                    email@example.com
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-gray-800" th:text="${partner.telephone}">
                    0123456789
                </td>
                <td class="px-6 py-4 text-gray-800" th:text="${partner.adresse}">
                    Adresse postale
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <a th:href="@{'/partners/edit/' + ${partner.id}}"
                       class="inline-flex items-center px-3 py-1 border border-transparent
                      text-xs leading-4 font-medium rounded text-indigo-700
                      bg-indigo-100 hover:bg-indigo-200">
                        ✏️ Modifier
                    </a>
                </td>
            </tr>
            <tr th:if="${#lists.isEmpty(partners)}" id="no-partners">
                <td class="px-6 py-4 text-center text-gray-600" colspan="7">
                    Aucun partenaire enregistré.
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ICI : fragment scripts appelé dans le layout principal -->
<th:block layout:fragment="scripts">
    <script>
        window.filterPartners = function (query) {
            query = query.toLowerCase();
            const rows = Array.from(document.querySelectorAll('#partnersTable tbody tr'))
                .filter(row => !row.id || row.id !== "no-partners");

            let countVisible = 0;
            rows.forEach(row => {
                if (row.innerText.toLowerCase().includes(query)) {
                    row.style.display = '';
                    countVisible++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Gère l'affichage du message "Aucun partenaire enregistré"
            const noPartnerRow = document.getElementById("no-partners");
            if (noPartnerRow) {
                noPartnerRow.style.display = (countVisible === 0) ? '' : 'none';
            }
        }
    </script>
</th:block>
</html>
